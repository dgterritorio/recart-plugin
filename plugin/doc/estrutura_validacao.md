# Estrutura de validação

Os processamentos de validação do plugin estão implementados com base num conjunto de funções e estruturas auxiliares `SQL` que são criadas na base de dados de teste quando se corre a  validação.

As estruturas auxiliares e funções definidas para validação são criadas no *schema* `validation` (este *schema* é criado caso não se encontre presente). São criadas as tabelas auxiliares seguintes para o processo de validação:

| Designação                                     | Tipo  | Propósito                                                                                                                                                                                                                                                                                                                                                                                                                           |
| ---------------------------------------------- | :---: | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `validation.area_trabalho_grid`                | table | Cria secções em grelha com base nas geometrias presentes na tabela `area_trabalho`. Utiliza a função `ST_SquareGrid` para esta criação com o tamanho de 10000.                                                                                                                                                                                                                                                                      |
| `validation.area_trabalho_multi`               | table | Utiliza a função `ST_Collect` para criar uma geometria multi polígono de maneira a suportar projetos com mais do que uma área de trabalho.                                                                                                                                                                                                                                                                                          |
| `validation.comissao`                          | table | Tabela auxiliar utilizada de maneira a definir a estrutura da tabela `errors.comissao_pq1_1` que é criada como cópia desta.                                                                                                                                                                                                                                                                                                         |
| `validation.conformidade`                      | table | Tabela auxiliar utilizada de maneira a definir a estrutura da tabela `errors.conformidade_pq2_1_1` que é criada como cópia desta.                                                                                                                                                                                                                                                                                                   |
| `validation.consistencia_valores_def`          | table | Tabela de suporte de maneira a definir os valores obrigatórios permitidos para os projetos de homologação de acordo com a versão da especificação e do nível de detalhe do projeto.                                                                                                                                                                                                                                                 |
| `validation.consistencia_valores_report`       | table | Utiliza os registos presentes na tabela `validation.consistencia_valores_def` de maneira a validar se os atributos correspondentes a listas de valores estão preenchidos conforme o esperado para um processo de homologação.                                                                                                                                                                                                       |
| `validation.curva_de_nivel_points_interval_v2` | table | Tabela auxiliar utiliza para a criação do `TIN`. Utiliza as funções `ST_DumpPoints` e `ST_LineInterpolatePoints` de maneira a obter pontos a partir dos elementos presentes na tabela `curva_de_nivel` aos quais realiza a união com os elementos da tabela `ponto_cotado`.                                                                                                                                                         |
| `validation.curva_nivel_tin`                   | table | Tabela onde é criado o TIN utilizado nas validações 3D. O TIN é criado com recurso à função `ST_DelaunayTriangles` aplicada sobre os elementos presentes na tabela `validation.curva_de_nivel_points_interval_v2`.                                                                                                                                                                                                                  |
| `validation.descontinuidades`                  | table | Tabela auxiliar utilizada de maneira a definir a estrutura da tabela `errors.descontinuidades_pq2_4_1` que é criada como cópia desta.                                                                                                                                                                                                                                                                                               |
| `validation.intersecoes_3d`                    | table | Tabela auxiliar utilizada de maneira a definir a estrutura de tabelas como a `errors.intersecoes_3d_rg_4_3_2` que são criadas como cópia desta.                                                                                                                                                                                                                                                                                     |
| `validation.no_hidro`                          | table | Tabela auxiliar que utiliza a função `ST_Collect` de maneira a manter a geometria de todos os nó hidrográficos num único registo.                                                                                                                                                                                                                                                                                                   |
| `validation.rules`                             | table | Tabela onde são registadas as regras de validação que vão ser executadas. Esta tabela contém as designações, âmbitos e propósitos de cada regra, para além de registar se elas devem ser executadas e qual os resultados associados à última vez que correram. O código `SQL` para cada regra está presente nos atributos `query` e `query_nd2`, a versão para a qual deve ser executada a regra é registada no atributo `versoes`. |
| `validation.rules_area`                        | table | Tabela análoga à tabela `validation.rules` alterando apenas o `SQL` associado a cada regra de maneira a suportar a execução por secções.                                                                                                                                                                                                                                                                                            |
| `validation.rules_area_report`                 | table | Tabela auxiliar que mantém o resultado da validação para cada secção considerada, permitindo assim também o retomar da execução em validações posteriores.                                                                                                                                                                                                                                                                          |

## Funções Auxiliares

As seguintes funções auxiliares são utilizadas para o processo de validação:


| Designação                                             |   Tipo   | Propósito                                                                                                                                                                                                                    |
| ------------------------------------------------------ | :------: | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `validation.atualiza_consistencia_valores_report`      | function | Utiliza a tabela `validation.consistencia_valores_def` de maneira a validar os atributos relativos a listas de valores de acordo com os valores obrigatórios para processos de homologação.                                  |
| `validation.create_tin`                                | function | Função responsável pela criação do TIN. Esta criação apenas acontece caso não seja detetada uma criação anterior.                                                                                                            |
| `validation.descontinuidades_seg_via_rodov_quadrantes` | function | Testa a existência de distâncias inferiores a 20 cm (`st_3ddistance`) entre extremos de segmentos da via rodoviária.                                                                                                         |
| `validation.do_validation`                             | function | Função responsável pelo processamento da validão. Percorre as regras marcadas para `run` e executa o SQL associado a cada uma.                                                                                               |
| `validation.rg_min_area`                               | function | Função utilizada na validação das áreas mínimas para polígonos.                                                                                                                                                              |
| `validation.validate_table_columns`                    | function | Verifica se uma tabela tem exatamente as colunas esperadas. Utilizada na validação da estrutura que corre sempre no início da validação.                                                                                     |
| `validation.validate_table_rows`                       | function | Verifica se as linhas esperadas numa determinada tabela se encontram presentes. Devolve como erro as linhas esperadas que não foram encontradas. Utilizada na validação dos valores que corre sempre no início da validação. |
| `validation.validcap_pt`                               | function | Função utilizada na validação dos nomes para verificar a utilização de maiúsculas conforme o estabelecido. Estão aqui definidas as exceções aceites (de, da, ..., EB1, etc.).                                               |
| `validation.valid_noabbr`                              | function | Função utilizada na validação dos nomes para garantir que não contêm abreviaturas do tipo letras maiúsculas seguidas de ponto.                                                                                               |
| `validation.valid_simple`                              | function | Função utilizada na validação das geometrias. Para linhas utiliza a função `ST_IsSimple`, para polígonos utiliza a função `ST_IsValid`.                                                                                      |
